# Feature Specification: Installation and Walking Skeleton

**Feature Branch**: `002-installer-skeleton`  
**Created**: 2025-12-26  
**Status**: Draft  
**Input**: User description: "1) Deliver a Python/uv installer that installs the following three artifacts:

For macOS/Linux (using $HOME):
    a) Create and populate the $HOME/.local/share/uv/tools/gmkit-cli/lib/python*/site-packages/gmkit_cli/ subfolder. The gmkit_cli subfolder is a package directory with __init__.py and other modules, not a single .py file.
    b) Install ```gmkit``` python file (without the .py extension) to ```$HOME/.local/share/uv/tools/gmkit-cli/bin/gmkit```. This is a short python file (with shebang, no .py extension) that wraps the logic in $HOME/.local/share/uv/tools/gmkit-cli/lib/python*/site-packages/gmkit_cli/.
    c) Create a symlink in $HOME/.local/bin/gmkit that points to ```gmkit``` under ```$HOME/.local/share/uv/tools/gmkit-cli/bin/gmkit```.
        ```$HOME/.local/bin/gmkit -> $HOME/.local/share/uv/tools/gmkit-cli/bin/gmkit```
        i.  This allows the command to be invoked from anywhere as $HOME/.local/bin is included in the OS PATH.

For Windows, mirror the same artifacts in uvâ€™s tool layout:
    a) Create and populate %LOCALAPPDATA%\uv\tools\gmkit-cli\Lib\site-packages\gmkit_cli\ (package directory with __init__.py and other modules).
    b) Install the entrypoint to %LOCALAPPDATA%\uv\tools\gmkit-cli\Scripts\gmkit.exe (or gmkit shim if uv emits one without extension); this wraps the logic in the Lib\site-packages\gmkit_cli\ folder. This .exe is generated by uv when the tool is installed.
    c) Create a shim at %USERPROFILE%\.local\bin\gmkit.cmd (preferred) that forwards to %LOCALAPPDATA%\uv\tools\gmkit-cli\Scripts\gmkit.exe, ensuring %USERPROFILE%\.local\bin is on PATH. If symlinks are available, a symlink is acceptable; if PowerShell is preferred, use gmkit.ps1. If the environment prefers WindowsApps or another PATH location, note that alternative but default to %USERPROFILE%\.local\bin.
        ```%USERPROFILE%\.local\bin\gmkit.cmd -> %LOCALAPPDATA%\uv\tools\gmkit-cli\Scripts\gmkit.exe```
        Example gmkit.cmd contents:
        ```bat
        @echo off
        \"%LOCALAPPDATA%\uv\tools\gmkit-cli\Scripts\gmkit.exe\" %*
        ```

2) This allows the user to invoke the python "gmkit" command (from a terminal) along with a subcommand "init" which takes three inputs: a) required path to temp folder for writing scripts/prompts, b) optional coding agent type (claude, codex-cli, gemini, qwen), c) optional target OS (windows for PowerShell or macos/linux for bash). If optional parameters are not provided, the Python script prompts the user to select them.

This will install the following folders and logic into the project folder (based on the OS and coding agent selected):

    - <project folder>/<agent folder>/prompts/ (or commands/, or similar): 
        - each coding agent has a different location for the prompts:
            - for claude the location is ```<project folder>/.claude/commands/``` (uses .md files)
            - for codex-cli the location is ```<project folder>/.codex/prompts/``` (uses .md files)
            - for gemini the location is ```<project folder>/.gemini/commands/``` (uses .toml files)
            - for qwen the location is ```<project folder>/.qwen/commands/``` (uses .toml files)
        - the prompt files: are the specific slash commands invoked inside the coding agent.  The first and only prompt file installed by ```gmkit init``` for this feature is:
            - gmkit.hello-gmkit.md for claude and codex-cli
            - gmkit.hello-gmkit.toml for gemini and qwen
    - <project folder>/.gmkit/memory/  (use `.gmkit` consistently across platforms)
        - constitution.md (contains the core principles the agent is supposed follow when creating TTRPG game master artifacts).
    - <project folder>/.gmkit/scripts/<bash or ps>/ (invoked by the agent on behalf of the /slash command/prompts listed above). 
        - say-hello.sh
    <project folder>/.gmkit/templates (simple template files that are populated with the arguments provided by the script files above).
        - hello-gmkit-template.md

3) Once the project folder has been initialized, the user can then launch his agent of choice and issue the /gmkit.hello-gmkit slash command, passing in a greeting such as "Hello from <Agent>!". This will cause the agent to read and act on behalf of the gmkit.hello-gmkit.md prompt content along with any user provided greeting. This will trigger the following events:
    - The agent will follow the instructions in the gmkit.hello-gmkit.md file to generate the argument list required to invoke the say-hello.sh file passing in the greeting from the user along with a greeting file sequence number.  The agent should determine the latest sequence number by evaluating the "<project folder>/greetings/greetingXX.md" files and looking for the highest sequence number and then incrementing that number by 1.
    - The script execution will fill in the template, replacing variables in the template with the argument list (in this case the single greeting message argument and the sequence number).
    - The script will write the contents of the greeting to the chat window and also write the contents to the markdown file path as "<project folder>/greetings/greetingXX.md", where XX is the numeric sequence number argument.

Non-functional requirements (must be explicit in spec):
    - gmkit init is safe to re-run and idempotent for existing folders/files (no destructive overwrites without clear user intent).
    - Script/template output is deterministic for the same inputs.
    - Clear, actionable error messages for missing paths/permissions.
    - No network access required after installation for hello-gmkit flow.
    - Templates, scripts, and prompts sourced from local gm-kit repo folders: templates/, scripts/, memory/ (mirroring spec-kit structure).

Out of scope (must be explicit in spec):
    - No real content generation beyond the minimal hello-gmkit scaffolding.
    - hello-gmkit is a temporary walking-skeleton command and will be removed once real commands exist.

Documentation must cover (include in spec and docs):
    - How a new slash command maps to its prompt/script/template artifacts and output path.
    - Campaign flow example: `/gmkit.campaign` installs prompt + script + template, and creates `<project folder>/campaigns/<campaign_name>/campaign_notes.md`.
    - Scenario flow example: `/gmkit.scenario` creates `<project folder>/campaigns/<campaign_name>/scenarios/<scenario_name>/scenario_notes.md`.
    - Two creation patterns: (1) create new folder/file outputs, (2) append a new section inside an existing notes file (e.g., `/gmkit.npc`, `/gmkit.encounter`, `/gmkit.reward` inside scenario notes).
    - Users can create multiple campaigns per project and multiple scenarios per campaign.

Success looks like: 

- contributors can install once with uv,
    - proven by integration tests that will 1) remove the gmkit-cli installation (if it's there) and then install it cleanly. The test will then verify the essential folders and files are present in the installation folder.
- contributors can run "gmkit init" from terminal (with required temp path and optional agent/OS params) have scripts/prompts copied to temp workspace for /gmkit.hello-gmkit
    - proven by tests verifying files in temp workspace, plus documentation on extending the skeleton.
- contributors can invoke /gmkit.hello-gmkit slash command from their coding agent choice of choice (selected during "gmkit init" command) and the "<project folder>/greetings/greetingXX.md" file will be written with the appropriate XX sequence number.
    - proven by tests that invoke the script directly to fill the template and verify the "<project folder>/greetings/greetingXX.md" file has been written. Agent CLI batch mode is currently non-viable (codex-cli, gemini, opencode) for clean slash-command invocation; codex output is not reliable for automated tests.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Install GM-Kit and Initialize Project (Priority: P1)

Contributors install GM-Kit using uv and run "gmkit init" to set up scripts and prompts for the walking skeleton, enabling basic slash command functionality.

**Why this priority**: This is the core installer and initializer that provides the foundation for all subsequent GM-Kit usage.

**Independent Test**: Can be fully tested by installing GM-Kit, running gmkit init, and verifying the correct files are created in the temp workspace.

**Acceptance Scenarios**:

1. **Given** uv is installed, **When** contributor runs `uv tool install gmkit-cli`, **Then** GM-Kit is installed with the gmkit command available in PATH and no network dependencies required after installation.
2. **Given** GM-Kit is installed, **When** contributor runs `gmkit init /path/to/temp --agent claude --os linux`, **Then** the temp folder is created with .gmkit/scripts/bash/, .gmkit/templates/, and .gmkit/memory/ subfolders, containing say-hello.sh script, hello-gmkit-template.md template, constitution.md, and claude prompts for /gmkit.hello-gmkit.
3. **Given** GM-Kit is installed, **When** contributor runs `gmkit init /path/to/temp --agent codex-cli --os linux`, **Then** the temp folder is created with .gmkit/scripts/bash/, .gmkit/templates/, and .gmkit/memory/ subfolders, containing say-hello.sh script, hello-gmkit-template.md template, constitution.md, and codex-cli prompts for /gmkit.hello-gmkit.
4. **Given** GM-Kit is installed, **When** contributor runs `gmkit init /path/to/temp --agent gemini --os linux`, **Then** the temp folder is created with .gmkit/scripts/bash/, .gmkit/templates/, and .gmkit/memory/ subfolders, containing say-hello.sh script, hello-gmkit-template.md template, constitution.md, and gemini prompts for /gmkit.hello-gmkit.
5. **Given** GM-Kit is installed, **When** contributor runs `gmkit init /path/to/temp --agent qwen --os linux`, **Then** the temp folder is created with .gmkit/scripts/bash/, .gmkit/templates/, and .gmkit/memory/ subfolders, containing say-hello.sh script, hello-gmkit-template.md template, constitution.md, and qwen prompts for /gmkit.hello-gmkit.
6. **Given** GM-Kit is installed, **When** contributor runs `gmkit init /path/to/temp` without optional params, **Then** the system prompts for OS and agent selections and creates the appropriate files.
7. **Given** initialized project, **When** contributor invokes /gmkit.hello-gmkit in their agent with a greeting, **Then** the greeting is written to greetings/greeting01.md (or next sequence number) with the template filled.
8. **Given** gmkit init has been run, **When** contributor runs it again with the same path, **Then** no destructive overwrites occur and idempotent behavior is maintained.

---

### User Story 2 - Cross-Platform Script Generation (Priority: P2)

The system generates platform-appropriate scripts (bash for macOS/Linux, PowerShell for Windows) with identical functionality.

**Why this priority**: Ensures GM-Kit works across all supported platforms without platform-specific limitations.

**Independent Test**: Can be fully tested by generating scripts for different OS/agent combinations and verifying they produce the same outputs.

**Acceptance Scenarios**:

1. **Given** gmkit init run with --os linux, **When** script is generated, **Then** bash script say-hello.sh is created with correct shebang and functionality.
2. **Given** gmkit init run with --os windows, **When** script is generated, **Then** PowerShell script say-hello.ps1 is created with equivalent functionality.
3. **Given** scripts for different platforms, **When** executed with same inputs, **Then** they produce identical outputs and file writes.

---

### User Story 3 - Agent Prompt Integration (Priority: P3)

The system provides agent-specific prompts that enable slash command functionality across all supported coding agents.

**Why this priority**: Allows GM-Kit to integrate with various AI coding assistants, expanding accessibility.

**Independent Test**: Can be fully tested by verifying correct prompt files are generated for each supported agent.

**Acceptance Scenarios**:

1. **Given** gmkit init run with specific agent, **When** prompts are generated, **Then** the correct prompt file is placed in the agent's expected location (e.g., .claude/command/ for claude).
2. **Given** generated prompts, **When** slash command is invoked in agent, **Then** the agent executes the associated script with correct arguments.

---

### Edge Cases

- What happens when temp folder path contains invalid characters or is read-only? Error with clear message.
- How does system handle unsupported agent types? Shows error with list of supported agents.
- What if uv installation fails due to missing dependencies? Clear error directing to uv documentation.
- How to handle cases where PATH is not set correctly for gmkit command? Error message with PATH setup instructions.
- What if multiple agents are selected? Only one agent selection allowed.
- What if sequence number determination fails? Fallback to 01 or error with guidance.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST install GM-Kit CLI tool using uv with cross-platform artifacts (symlinks/shims for PATH access).
- **FR-002**: System MUST provide gmkit init command that accepts required temp path and optional agent/OS parameters.
- **FR-003**: System MUST create .gmkit/scripts/, .gmkit/templates/, and .gmkit/memory/ subfolders in temp workspace.
- **FR-004**: System MUST generate platform-specific scripts (bash/PowerShell) with identical inputs/outputs.
- **FR-005**: System MUST generate agent-specific prompts for /gmkit.hello-gmkit slash command with correct file formats (.md for claude/codex-cli, .toml for gemini/qwen).
- **FR-016**: System MUST use single-source template strategy where markdown content serves as source of truth and TOML files are generated by embedding markdown content into TOML format.
- **FR-017**: System MUST validate generated TOML files using Python's built-in `tomllib` library without requiring external dependencies for TOML format verification.
- **FR-006**: System MUST populate constitution.md in .gmkit/memory/ with GM-Kit principles.
- **FR-007**: System MUST support all specified coding agents with their specific file formats and folder structures:
    - claude: .claude/commands/ with .md prompt files
    - codex-cli: .codex/prompts/ with .md prompt files  
    - gemini: .gemini/commands/ with .toml prompt files
    - qwen: .qwen/commands/ with .toml prompt files
- **FR-008**: System MUST provide interactive prompts when optional parameters are omitted.
- **FR-009**: System MUST ensure idempotent gmkit init execution without destructive overwrites.
- **FR-010**: System MUST generate deterministic outputs for same inputs.
- **FR-011**: System MUST provide clear, actionable error messages for failures.
- **FR-012**: System MUST support sequence number determination for greeting files.
- **FR-013**: System MUST write greeting files to <project folder>/greetings/ with incremented sequence numbers.
- **FR-014**: System MUST include documentation covering slash command mapping and creation patterns.
- **FR-015**: System MUST exclude real content generation beyond hello-gmkit scaffolding.
- **FR-016**: System MUST require no network access after installation for hello-gmkit functionality.

### Key Entities *(include if feature involves data)*

- **Coding Agent**: Type of AI assistant (claude, codex-cli, gemini, qwen) determining prompt location and file format. Agents must be pre-installed and accessible.
  - claude: .claude/commands/ with .md files
  - codex-cli: .codex/prompts/ with .md files  
  - gemini: .gemini/commands/ with .toml files
  - qwen: .qwen/commands/ with .toml files
- **Operating System**: Target platform (macos/linux, windows) determining script type.
- **Temp Workspace**: File system location for generated scripts, templates, and memory files.
- **Script File**: Executable file (bash or PowerShell) that processes slash command arguments.
- **Prompt File**: Agent-specific instruction file for slash command behavior.
- **Template File**: Markdown template for generating output files.
- **Greeting File**: Sequenced markdown file containing processed greetings.

## Automated Testing Documentation

The success outcomes are validated through automated integration tests that verify the installation, initialization, and slash command execution flows.

### Installation Tests
- **Test**: Remove existing gmkit-cli installation (if present), run `uv tool install gmkit-cli`, verify installation completes without errors.
- **Verification**: Check that $HOME/.local/share/uv/tools/gmkit-cli/ (or Windows equivalent) contains the required subfolders and files, gmkit command is available in PATH, no network dependencies required post-install.
- **Linux CI Test**: On `ubuntu-latest`, run `uv tool install gmkit-cli`, verify `$HOME/.local/share/uv/tools/gmkit-cli/` contains the required subfolders and `$HOME/.local/bin/gmkit` symlink points to the uv tool entrypoint.

### Initialization Tests
- **Test**: Run `gmkit init /temp/path --agent claude --os linux` (and variations for all agent/OS combinations), verify temp workspace is created with correct subfolders.
- **Verification**: Confirm .gmkit/scripts/bash/say-hello.sh, .gmkit/templates/hello-gmkit-template.md, .gmkit/memory/constitution.md, and agent-specific prompts are present and correctly formatted.
- **Agent Validation Tests**: Run `gmkit init` with uninstalled agent (e.g., simulate missing qwen), verify error message with install link and graceful exit.
- **Linux CI Test**: On `ubuntu-latest`, run `gmkit init /tmp/gmkit-test --agent claude --os linux`, verify .gmkit/scripts/bash/say-hello.sh, templates, memory, and agent-specific prompts are created.

### Slash Command Tests
- **Test**: Invoke say-hello.sh script directly with arguments (greeting message, sequence number), verify template filling and file writing.
- **Verification**: Check that <project folder>/greetings/greetingXX.md is created with correct content and sequence numbering.
- **Linux CI Test**: Invoke say-hello.sh directly with arguments, verify template filling and greeting file creation.
- **Linux Parity Test**: If `pwsh` is available, invoke say-hello.ps1 via PowerShell on Linux with the same inputs and compare outputs to the bash version.
- **Testing Requirement**: PowerShell (`pwsh`) must be available on Linux to run parity tests; skip parity tests if `pwsh` is not installed.
- **Optional Agent Tests**: Deferred. Agent CLI batch mode is currently non-viable (codex-cli, gemini, opencode) for clean slash-command invocation; codex output is not reliable for automated tests.

### Extension Documentation
- Include guidance on extending the walking skeleton: how to add new slash commands by creating corresponding prompt/script/template files, with examples for /gmkit.campaign and /gmkit.scenario creation patterns.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Contributors can install GM-Kit with uv in under 5 minutes and invoke gmkit command from terminal.
- **SC-002**: gmkit init completes script/prompt generation in under 30 seconds for all supported combinations.
- **SC-003**: 100% of generated scripts/templates work across supported platforms and agents.
- **SC-004**: System handles 100% of edge cases with clear error messages.
- **SC-005**: /gmkit.hello-gmkit slash command writes correctly sequenced greeting files in under 10 seconds.
- **SC-006**: Documentation enables developers to extend the skeleton for new commands within 1 hour.
